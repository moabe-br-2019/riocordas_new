---
import Layout from '../layouts/Layout.astro';
// Footer removido conforme solicitado
import { CONTRACT_CLAUSES } from '../data/contractClauses';

// Configura√ß√£o do reCAPTCHA Enterprise
const recaptchaSiteKey =
  import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY || '6LddECEsAAAAABtUQk25e_vpSNHPTCsQVeEDB96u';

// URL do Google Apps Script
const googleScriptUrl =
  import.meta.env.PUBLIC_GOOGLE_SCRIPT_URL || 'https://script.google.com/macros/s/AKfycbzpgfCcYS9US2iD5y7dvh9YNTIMDQ_TnqTMFQFACrDu6QXkILjQgmuFig4Nc_Z31eFPgg/exec';
---

<Layout
    title="Formul√°rio de Contrato - Rio Cordas"
    description="Preencha o formul√°rio para contratar os m√∫sicos da Rio Cordas. Escolha seus instrumentos, formas de pagamento e assine o contrato online."
>
    <div class="contract-form-wrapper">
        <!-- Modal de Edi√ß√£o de Email -->
        <div id="emailModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Alterar Email</h3>
                    <button type="button" class="modal-close" id="closeEmailModal">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="emailModalInput">Novo Email:</label>
                        <input type="email" id="emailModalInput" placeholder="seu@email.com">
                        <div class="error-message" id="modalEmailError"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="cancelEmailBtn">Cancelar</button>
                    <button type="button" class="btn-primary" id="confirmEmailBtn">Confirmar</button>
                </div>
            </div>
        </div>

        <div class="contract-container">
            <div class="form-header">
                <h1>Formul√°rio de Contrato</h1>
                <p class="form-subtitle">Preencha as informa√ß√µes abaixo para formalizar sua contrata√ß√£o</p>
            </div>

            <!-- Email Display Bar -->
            <div id="emailDisplayBar" class="email-display-bar" style="display: none;">
                <div class="email-display-content">
                    <span class="email-label">Email:</span>
                    <span id="displayedEmail" class="email-value"></span>
                    <button type="button" class="btn-edit-email" id="editEmailBtn" title="Editar email">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </div>

            <form id="contractForm" class="contract-form">
                <!-- ETAPA 0: Email e Captcha -->
                <div class="form-step" id="step-0">
                    <div class="form-hint">
                        <i class="fas fa-envelope"></i>
                        Por favor, insira seu e-mail antes de iniciar.<br>O contrato completo ser√° enviado posteriormente para o endere√ßo de e-mail informado.
                    </div>
                    <div class="form-group">
                        <label for="email">Email*</label>
                        <input type="email" id="email" name="email" required aria-required="true" placeholder="seu@email.com">
                        <div class="error-message" id="emailError"></div>
                    </div>
                </div>

                <!-- ETAPA 1: Dados do Contratante -->
                <div class="form-step" id="step-1" style="display: none;">
                    <h2>Dados do Contratante</h2>
                    <div class="form-hint">
                        <i class="fas fa-info-circle"></i>
                        Todos os campos marcados com * s√£o obrigat√≥rios
                    </div>
                    <div class="form-group">
                        <label for="fullName">Nome Completo*</label>
                        <input type="text" id="fullName" name="fullName" required aria-required="true" placeholder="Seu nome completo">
                        <div class="error-message" id="fullNameError"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rg">RG <span class="optional">(opcional)</span></label>
                            <input type="text" id="rg" name="rg" placeholder="Seu RG">
                        </div>
                        <div class="form-group">
                            <label for="cpf">CPF*</label>
                            <input type="text" id="cpf" name="cpf" required aria-required="true" placeholder="000.000.000-00" maxlength="14">
                            <p class="field-hint">Ser√° formatado automaticamente</p>
                            <div class="error-message" id="cpfError"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="address">Endere√ßo*</label>
                        <input type="text" id="address" name="address" required aria-required="true" placeholder="Rua, n√∫mero, complemento">
                        <div class="error-message" id="addressError"></div>
                    </div>
                    <div class="form-group">
                        <label for="phone">Celular*</label>
                        <input type="tel" id="phone" name="phone" required aria-required="true" placeholder="(00) 99999-9999">
                        <p class="field-hint">Ser√° formatado automaticamente conforme voc√™ digita</p>
                        <div class="error-message" id="phoneError"></div>
                    </div>
                </div>

                <!-- ETAPA 2: Dados do Evento -->
                <div class="form-step" id="step-2" style="display: none;">
                    <h2>Dados do Evento</h2>
                    <div class="form-group">
                        <label for="venueName">Nome da Casa de Festas ou Igreja</label>
                        <input type="text" id="venueName" name="venueName" placeholder="Ex: Igreja S√£o Jos√©">
                    </div>
                    <div class="form-group">
                        <label for="venueAddress">Endere√ßo do Evento*</label>
                        <input type="text" id="venueAddress" name="venueAddress" required aria-required="true" placeholder="Endere√ßo completo">
                        <div class="error-message" id="venueAddressError"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventDate">Data do Evento*</label>
                            <input type="date" id="eventDate" name="eventDate" required aria-required="true">
                            <div class="error-message" id="eventDateError"></div>
                        </div>
                        <div class="form-group">
                            <label for="guestArrivalTime">Hor√°rio de Chegada dos Convidados*</label>
                            <input type="time" id="guestArrivalTime" name="guestArrivalTime" required aria-required="true">
                            <p class="field-hint">M√°ximo de 1 hora de intervalo at√© o in√≠cio da cerim√¥nia</p>
                            <div class="error-message" id="guestArrivalTimeError"></div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ceremonyStartTime">Hor√°rio de In√≠cio da Cerim√¥nia*</label>
                            <input type="time" id="ceremonyStartTime" name="ceremonyStartTime" required aria-required="true">
                            <div class="error-message" id="ceremonyStartTimeError"></div>
                        </div>
                        <div class="form-group">
                            <label for="guestCount">N√∫mero de Convidados*</label>
                            <input type="number" id="guestCount" name="guestCount" required aria-required="true" min="1" placeholder="Aproximadamente">
                            <div class="error-message" id="guestCountError"></div>
                        </div>
                    </div>
                </div>

                <!-- ETAPA 3: Forma√ß√£o Instrumental -->
                <div class="form-step" id="step-3" style="display: none;">
                    <h2>Forma√ß√£o Instrumental</h2>
                    <p class="form-description">Escolha a forma√ß√£o que deseja para seu evento:</p>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="formation" value="dueto" required>
                            <span class="radio-label">Dueto Instrumental</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="formation" value="trio" required>
                            <span class="radio-label">Trio Instrumental</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="formation" value="quarteto" required>
                            <span class="radio-label">Quarteto Instrumental</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="formation" value="quinteto" required>
                            <span class="radio-label">Quinteto Instrumental</span>
                        </label>
                    </div>
                    <div class="error-message" id="formationError"></div>
                </div>

                <!-- ETAPA 4: Instrumentos Escolhidos -->
                <div class="form-step" id="step-4" style="display: none;">
                    <h2>Instrumentos da Forma√ß√£o</h2>
                    <div class="radio-group" id="instrumentsContainer">
                        <!-- Preenchido dinamicamente pelo JavaScript -->
                    </div>
                    <div class="error-message" id="instrumentsError"></div>
                </div>

                <!-- ETAPA 5: Trompete Triunfal -->
                <div class="form-step" id="step-5" style="display: none;">
                    <h2>Trompete Triunfal</h2>
                    <p class="form-description">Deseja adicionar trompete para a entrada dos noivos?</p>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="trumpet" value="um" required>
                            <span class="radio-label">1 Trompete</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="trumpet" value="dois" required>
                            <span class="radio-label">2 Trompetes</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="trumpet" value="nenhum" required>
                            <span class="radio-label">Sem Trompetes</span>
                        </label>
                    </div>
                    <div class="error-message" id="trumpetError"></div>
                </div>

                <!-- ETAPA 6: Sonoriza√ß√£o -->
                <div class="form-step" id="step-6" style="display: none;">
                    <h2>Sonoriza√ß√£o</h2>
                    <p class="form-description">Escolha a op√ß√£o de sonoriza√ß√£o para seu evento:</p>
                    <div class="radio-group" id="soundOptionsContainer">
                        <!-- Preenchido dinamicamente pelo JavaScript -->
                    </div>
                    <div class="error-message" id="soundError"></div>
                </div>

                <!-- ETAPA 7: Termos e Condi√ß√µes -->
                <div class="form-step" id="step-7" style="display: none;">
                    <h2>Termos e Condi√ß√µes do Contrato</h2>
                    <div class="contract-clauses">
                        <!-- Aqui usamos a vari√°vel importada -->
                        <textarea id="clauses" readonly>{CONTRACT_CLAUSES}</textarea>
                    </div>
                    <label class="checkbox-option">
                        <input type="checkbox" id="acceptTerms" name="acceptTerms" required aria-required="true">
                        <span>Li e concordo com os Termos e Condi√ß√µes da Contrata√ß√£o descritos acima, incluindo a pol√≠tica de cancelamento e toler√¢ncia de hor√°rios.*</span>
                    </label>
                    <div class="error-message" id="termsError"></div>
                </div>

                <!-- ETAPA 8: Forma de Pagamento -->
                <div class="form-step" id="step-8" style="display: none;">
                    <h2>Forma de Pagamento</h2>
                    <p class="form-description">Escolha a forma de pagamento que deseja:</p>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="payment" value="vista" required>
                            <span class="radio-label">√Ä Vista</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="payment" value="2x" required>
                            <span class="radio-label">Parcelado em 2x (30% de sinal + restante na semana do evento)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="payment" value="3x" required>
                            <span class="radio-label">Parcelado em 3x (3 parcelas iguais - primeira na assinatura)</span>
                        </label>
                    </div>
                    <div class="error-message" id="paymentError"></div>
                </div>

                <!-- ETAPA 9: Resumo de Valores e Considera√ß√µes Finais -->
                <div class="form-step" id="step-9" style="display: none;">
                    <h2>Resumo de Valores</h2>
                    <p class="form-description">Confira os valores do seu contrato:</p>

                    <div class="pricing-summary">
                        <table class="pricing-table">
                            <tbody id="pricingSummaryBody">
                                <!-- Preenchido dinamicamente -->
                            </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td><strong>VALOR TOTAL</strong></td>
                                    <td><strong id="totalPrice">R$ 0,00</strong></td>
                                </tr>
                            </tfoot>
                        </table>

                        <div class="payment-summary" id="paymentSummary">
                            <!-- Preenchido dinamicamente com parcelas -->
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 30px;">
                        <h3 style="font-family: 'Playfair Display', serif; font-size: 20px; color: #333; margin-bottom: 15px;">Considera√ß√µes Finais</h3>
                        <label for="finalObservations">Perguntas, d√∫vidas ou solicita√ß√µes especiais:</label>
                        <textarea id="finalObservations" name="finalObservations" placeholder="Deixe aqui qualquer pergunta, d√∫vida sobre as cl√°usulas ou qualquer outra solicita√ß√£o..."></textarea>
                    </div>
                </div>

                <!-- Bot√µes de Navega√ß√£o -->
                <div class="form-navigation">
                    <button type="button" class="btn-secondary" id="prevBtn" style="display: none;">Voltar</button>
                    <button type="button" class="btn-primary" id="nextBtn">Pr√≥ximo</button>
                    <button type="submit" class="btn-submit" id="submitBtn" style="display: none;">Enviar Contrato</button>
                </div>
            </form>

            <!-- Overlay de Carregamento -->
            <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p class="loading-text">Enviando seu contrato...</p>
                </div>
            </div>

            <!-- Mensagem de Sucesso -->
            <div id="successMessage" class="success-message" style="display: none;">
                <div class="success-icon">
                    <i class="fas fa-check"></i>
                </div>
                <h3>Contrato Enviado com Sucesso!</h3>
                <p>Obrigado pelo seu contato. Em breve entraremos em contato para confirmar os detalhes e formas de pagamento.</p>
                <div class="success-actions">
                    <div class="btn-action-wrapper">
                        <a href="https://riocordas.com.br" class="btn-action btn-icon btn-primary" title="Voltar para o Site">
                            <i class="fas fa-home"></i>
                        </a>
                        <span class="btn-action-text">Voltar ao Site</span>
                    </div>
                    <div class="btn-action-wrapper">
                        <a href="https://www.youtube.com/@riocordas" target="_blank" class="btn-action btn-icon btn-secondary" title="Visite nosso YouTube">
                            <i class="fab fa-youtube"></i>
                        </a>
                        <span class="btn-action-text">YouTube</span>
                    </div>
                    <div class="btn-action-wrapper">
                        <a href="https://www.instagram.com/riocordas" target="_blank" class="btn-action btn-icon btn-secondary" title="Siga no Instagram">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <span class="btn-action-text">Instagram</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</Layout>

<style>
    /* ... seus estilos existentes ... */
    .contract-form-wrapper { background-color: #f9f9f9; padding: 60px 20px; min-height: 80vh; position: relative; }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.3s ease; }
    .modal-content { background-color: white; border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); max-width: 500px; width: 90%; animation: slideUp 0.3s ease; }
    .modal-header { padding: 25px 25px 15px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { font-family: 'Playfair Display', serif; font-size: 20px; color: #333; margin: 0; }
    .modal-close { background: none; border: none; font-size: 32px; cursor: pointer; color: #999; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; transition: color 0.3s ease; }
    .modal-close:hover { color: #333; }
    .modal-body { padding: 25px; }
    .modal-footer { padding: 15px 25px 25px; display: flex; gap: 15px; justify-content: flex-end; }
    .modal-footer .btn-primary, .modal-footer .btn-secondary { flex: none; padding: 10px 25px; font-size: 14px; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .email-display-bar { background-color: white; border-bottom: 1px solid #e0e0e0; padding: 15px 30px; display: flex; align-items: center; justify-content: center; }
    .email-display-content { display: flex; align-items: center; gap: 12px; max-width: 800px; }
    .email-label { font-weight: 600; color: #333; font-size: 14px; }
    .email-value { color: var(--accent-color); font-size: 14px; word-break: break-all; }
    .btn-edit-email { background: none; border: none; color: var(--accent-color); cursor: pointer; font-size: 16px; padding: 5px; transition: color 0.3s ease; display: flex; align-items: center; justify-content: center; }
    .btn-edit-email:hover { color: #d93600; }
    .contract-container { max-width: 800px; margin: 0 auto; background-color: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); overflow: hidden; }
    .form-header { background: #000000; color: white; padding: 40px 30px; text-align: center; }
    .form-header h1 { font-family: 'Playfair Display', serif; font-size: 32px; margin-bottom: 10px; }
    .form-subtitle { font-size: 16px; opacity: 0.9; margin-bottom: 25px; }
    .contract-form { padding: 40px 30px; }
    .form-step { animation: fadeIn 0.5s ease; opacity: 1; transition: opacity 0.5s ease; }
    .form-step.fade-out { opacity: 0; transition: opacity 0.3s ease; }
    .form-step h2 { font-family: 'Playfair Display', serif; font-size: 24px; color: #333; margin-bottom: 25px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
    .form-description { color: #666; margin-bottom: 20px; font-size: 15px; }
    .form-group { margin-bottom: 25px; }
    .form-group label { display: block; margin-bottom: 10px; font-weight: 500; color: #333; font-size: 14px; }
    .form-group input[type="text"], .form-group input[type="email"], .form-group input[type="tel"], .form-group input[type="date"], .form-group input[type="time"], .form-group input[type="number"], .form-group textarea { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Montserrat', sans-serif; font-size: 14px; transition: border-color 0.3s ease; box-sizing: border-box; }
    .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(242, 60, 0, 0.1); }
    .form-group textarea { resize: vertical; min-height: 120px; font-family: 'Montserrat', sans-serif; width: 100%; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .radio-group { display: flex; flex-direction: column; gap: 15px; }
    .contract-clauses textarea { font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.6; background-color: #f9f9f9; color: #333; min-height: 300px; width: 100%; }
    @media (min-width: 769px) { .contract-clauses textarea { min-height: 500px; } }
    .form-hint { background-color: rgba(242, 60, 0, 0.08); border-left: 4px solid var(--accent-color); padding: 15px 15px; border-radius: 4px; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; font-size: 14px; color: #d93600; line-height: 1.6; }
    .form-hint i { font-size: 18px; flex-shrink: 0; }
    .field-hint { font-size: 12px; color: #999; margin-top: 5px; margin-bottom: 0; font-style: italic; }
    .optional { color: #999; font-size: 12px; font-weight: 400; }
    .error-message { color: #ff3b30; font-size: 12px; margin-top: 5px; display: none; }
    .error-message.active { display: block; }
    .success-message { text-align: center; padding: 50px 30px; }
    .success-message h3 { font-family: 'Playfair Display', serif; font-size: 26px; color: #333; margin-bottom: 15px; }
    .success-message p { color: #666; font-size: 15px; line-height: 1.6; }
    .form-navigation { display: flex; gap: 15px; margin-top: 40px; justify-content: space-between; }
    .btn-primary, .btn-secondary, .btn-submit { padding: 12px 30px; font-size: 15px; font-weight: 600; border: none; border-radius: 4px; cursor: pointer; transition: all 0.3s ease; font-family: 'Montserrat', sans-serif; text-transform: uppercase; letter-spacing: 0.5px; }
    .btn-primary, .btn-submit { background-color: var(--accent-color); color: white; flex: 1; }
    .btn-primary:hover, .btn-submit:hover { background-color: #d93600; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(242, 60, 0, 0.3); }
    .btn-secondary { background-color: #e0e0e0; color: #333; flex: 1; }
    .btn-secondary:hover { background-color: #d0d0d0; transform: translateY(-2px); }
    .success-actions { display: flex; flex-direction: row; gap: 40px; margin-top: 40px; justify-content: center; flex-wrap: wrap; }
    .btn-action-wrapper { display: flex; flex-direction: column; align-items: center; gap: 12px; }
    .btn-action-text { font-size: 13px; font-weight: 500; color: #666; }
    .btn-action { display: inline-block; padding: 12px 30px; font-size: 15px; font-weight: 600; border: none; border-radius: 4px; cursor: pointer; transition: all 0.3s ease; font-family: 'Montserrat', sans-serif; text-transform: uppercase; letter-spacing: 0.5px; text-decoration: none; text-align: center; }
    
    /* Estilos para √çcones Redondos */
    .btn-action.btn-icon {
        padding: 0 !important; 
        border-radius: 50% !important;
        width: 60px; 
        height: 60px;
        min-width: 60px; 
        min-height: 60px; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        font-size: 0; 
        line-height: 1; 
        flex-shrink: 0;
    }
    .btn-action.btn-icon i { font-size: 24px; display: block; line-height: 1; }
    
    .btn-action.btn-secondary { 
        background-color: #f0f0f0; 
        color: #333; 
        border: 2px solid var(--accent-color); 
    }
    .btn-action.btn-secondary:hover { 
        background-color: var(--accent-color); 
        color: white; 
        transform: translateY(-2px); 
        box-shadow: 0 5px 15px rgba(242, 60, 0, 0.2); 
    }
    
    .success-icon, .error-icon {
        width: 120px; height: 120px; font-size: 60px; margin-bottom: 30px;
        display: inline-flex; align-items: center; justify-content: center;
        animation: scaleIn 0.5s ease; border-radius: 50%; line-height: 1;
    }
    .success-icon { color: #2ecc71; background-color: rgba(46, 204, 113, 0.1); }
    .error-icon { color: #ff3b30; background-color: rgba(255, 59, 48, 0.1); }

    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 2000; }
    .loading-container { background-color: white; border-radius: 12px; padding: 50px 40px; text-align: center; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); animation: slideUp 0.3s ease; }
    .spinner { width: 50px; height: 50px; border: 5px solid #f0f0f0; border-top: 5px solid var(--accent-color); border-radius: 50%; margin: 0 auto 20px; animation: spin 1s linear infinite; }
    .loading-text { color: #333; font-size: 16px; font-weight: 600; margin: 0; font-family: 'Montserrat', sans-serif; }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes scaleIn { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }

    /* Estilos para Resumo de Valores */
    .pricing-summary {
        background-color: white;
        border: 1px solid #e5e5e5;
        border-radius: 12px;
        padding: 30px;
        margin-top: 25px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .pricing-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 0;
    }

    .pricing-table tbody tr {
        border-bottom: 1px solid #f0f0f0;
    }

    .pricing-table tbody tr:last-child {
        border-bottom: 1px solid #e0e0e0;
    }

    .pricing-table td {
        padding: 16px 0;
        font-size: 15px;
        line-height: 1.5;
    }

    .pricing-table td:first-child {
        color: #2c3e50;
        font-weight: 400;
    }

    .pricing-table td:last-child {
        text-align: right;
        font-weight: 400;
        color: #2c3e50;
        white-space: nowrap;
    }

    .total-row {
        border-top: none !important;
        border-bottom: none !important;
    }

    .total-row td {
        padding: 20px 0 0 0 !important;
        font-size: 20px !important;
        font-weight: 700 !important;
    }

    .total-row td:first-child {
        color: var(--accent-color) !important;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .total-row td:last-child {
        color: var(--accent-color) !important;
    }

    .payment-summary {
        background-color: #fff9f5;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        border: 1px solid #ffe5d0;
    }

    .payment-summary h3 {
        font-family: 'Playfair Display', serif;
        font-size: 16px;
        color: var(--accent-color);
        margin-bottom: 16px;
        margin-top: 0;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .payment-summary h3::before {
        content: 'üìã';
        font-size: 18px;
    }

    .payment-summary .installment {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
    }

    .payment-summary .installment:last-child {
        border-bottom: none;
    }

    .payment-summary .installment span {
        font-size: 14px;
    }

    .payment-summary .installment span:first-child {
        color: #666;
    }

    .payment-summary .installment strong {
        color: #2c3e50;
        font-size: 15px;
        font-weight: 600;
    }

    @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; gap: 0; } .form-header { padding: 30px 20px; } .form-header h1 { font-size: 24px; } .contract-form { padding: 25px 20px; } .form-navigation { flex-direction: column; } .btn-primary, .btn-secondary, .btn-submit { padding: 12px 20px; font-size: 14px; } }
    @media (max-width: 480px) { .form-header { padding: 20px 15px; } .form-header h1 { font-size: 20px; } .form-header p { font-size: 14px; } .contract-form { padding: 20px 15px; } .form-step h2 { font-size: 20px; } .success-actions { flex-direction: row; gap: 20px; } .btn-action { width: auto; padding: 12px 20px; font-size: 14px; } .btn-action-wrapper { gap: 8px; } .btn-action-text { font-size: 11px; } .success-icon { width: 80px; height: 80px; font-size: 40px; } }
</style>

<style is:global>
    /* Estilo para radio options din√¢micos */
    .radio-option, .checkbox-option {
        display: flex; align-items: center; cursor: pointer; padding: 12px 15px;
        border: 2px solid #e0e0e0; border-radius: 4px; transition: all 0.3s ease;
    }
    .radio-option:hover, .checkbox-option:hover {
        border-color: var(--accent-color); background-color: rgba(242, 60, 0, 0.05);
    }
    .radio-option input[type="radio"], .radio-option input[type="checkbox"], .checkbox-option input[type="checkbox"] {
        margin-right: 12px; cursor: pointer; width: 18px; height: 18px; accent-color: var(--accent-color);
    }
    .radio-label { font-size: 15px; color: #333; }
</style>

<script define:vars={{ googleScriptUrl }}>
// Sem @ts-nocheck! TypeScript puro agora.

interface InstrumentOptions {
    [key: string]: string[];
}

interface PricingItem {
    id: number;
    Ano: string | number;
    'Pacote Sample': Array<{id: number; value: string; order: string}> | string;
    'Pre√ßo': string | number;
    'Pre√ßo promocional': string | number;
}

let currentStep: number = 0;
const totalSteps: number = 10; // Total de steps no formul√°rio
let pricingData: PricingItem[] = [];
let eventYear: number | null = null;

const instrumentOptions: InstrumentOptions = {
    dueto: ['Violino + Teclado', 'Voz + Teclado', 'Flauta + Teclado', 'Sax + Teclado'],
    trio: ['Violino + Cello + Teclado', 'Violino + Flauta + Teclado', 'Violino + Voz + Teclado', 'Violino + Sax + Teclado'],
    quarteto: ['2 Violinos + Cello + Teclado', 'Violino + Flauta + Cello + Teclado', 'Violino + Cello + Voz + Teclado', 'Violino + Cello + Sax + Teclado', '2 Violinos + Viola + Cello (Quarteto Cl√°ssico)'],
    quinteto: ['2 Violinos + Viola + Cello + Teclado', '2 Violinos + Flauta + Cello + Teclado', '2 Violinos + Cello + Voz + Teclado', '2 Violinos + Voz + Sax + Teclado']
};

// Fun√ß√µes utilit√°rias para buscar e processar pre√ßos
async function fetchPricingForYear(year: number) {
    try {
        const response = await fetch('/api/valores');
        const data = await response.json();

        if (!data.success) throw new Error('Erro ao buscar pre√ßos');

        // Filtrar pre√ßos do ano espec√≠fico
        // O campo 'Ano' pode vir como string ou n√∫mero
        pricingData = data.pricing.filter((p: any) => {
            const itemYear = typeof p.Ano === 'string' ? parseInt(p.Ano) : p.Ano;
            return itemYear === year;
        });

        console.log('Pre√ßos carregados para o ano', year, pricingData);
        return pricingData;
    } catch (error) {
        console.error('Erro ao buscar pre√ßos:', error);
        alert('Erro ao carregar pre√ßos. Por favor, recarregue a p√°gina.');
        return [];
    }
}

function getPriceByName(packageName: string): number {
    const item = pricingData.find(p => {
        const pacoteSample = p['Pacote Sample'];

        // Pacote Sample pode ser um array de objetos ou string
        if (Array.isArray(pacoteSample)) {
            return pacoteSample.some(pkg =>
                pkg.value?.toLowerCase().includes(packageName.toLowerCase())
            );
        }

        // Se for string
        if (typeof pacoteSample === 'string') {
            return pacoteSample.toLowerCase().includes(packageName.toLowerCase());
        }

        return false;
    });

    if (!item) {
        console.warn('Pre√ßo n√£o encontrado para:', packageName);
        return 0;
    }

    // Converter pre√ßos de string para n√∫mero
    const precoPromocional = typeof item['Pre√ßo promocional'] === 'string'
        ? parseFloat(item['Pre√ßo promocional'])
        : item['Pre√ßo promocional'];

    const preco = typeof item['Pre√ßo'] === 'string'
        ? parseFloat(item['Pre√ßo'])
        : item['Pre√ßo'];

    return precoPromocional || preco || 0;
}

function formatPrice(price: number): string {
    return price.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

document.addEventListener('DOMContentLoaded', function() {
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    const submitBtn = document.getElementById('submitBtn');

    setupEmailModal();

    if (nextBtn) nextBtn.addEventListener('click', () => goToNextStep());
    if (prevBtn) prevBtn.addEventListener('click', () => goToPreviousStep());
    
    if (submitBtn) {
        submitBtn.addEventListener('click', (e: Event) => {
            e.preventDefault();
            submitForm();
        });
    }

    const formationRadios = document.querySelectorAll('input[name="formation"]');
    formationRadios.forEach(radio => {
        radio.addEventListener('change', updateInstruments);
    });

    setupInputMasks();

    showStep(currentStep);
});

function getInputValue(id: string): string {
    const el = document.getElementById(id) as HTMLInputElement | HTMLTextAreaElement | null;
    return el ? el.value.trim() : '';
}

function isInputChecked(name: string): boolean {
    const el = document.querySelector(`input[name="${name}"]:checked`);
    return el !== null;
}

function getCheckedValue(name: string): string {
    const el = document.querySelector(`input[name="${name}"]:checked`) as HTMLInputElement | null;
    return el ? el.value : '';
}

function showStep(step: number) {
    const steps = document.querySelectorAll('.form-step');
    steps.forEach(s => {
        const el = s as HTMLElement;
        if (el.style.display !== 'none') el.classList.add('fade-out');
    });

    setTimeout(() => {
        steps.forEach(s => {
            const el = s as HTMLElement;
            el.style.display = 'none';
            el.classList.remove('fade-out');
        });

        const currentStepElement = document.getElementById('step-' + step);
        if (currentStepElement) {
            currentStepElement.style.display = 'block';
        }

        // Ao entrar no step 9 (resumo), calcular valores
        if (step === 9) {
            calculateAndDisplaySummary();
        }

        const emailDisplayBar = document.getElementById('emailDisplayBar');
        if (emailDisplayBar) {
            emailDisplayBar.style.display = step > 0 ? 'flex' : 'none';
        }

        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');

        if (prevBtn) prevBtn.style.display = step > 0 ? 'block' : 'none';
        if (submitBtn) submitBtn.style.display = step === 9 ? 'block' : 'none';
        if (nextBtn) nextBtn.style.display = step !== 9 ? 'block' : 'none';

        document.querySelector('.contract-form')?.scrollIntoView({ behavior: 'smooth' });
    }, 300);
}

function goToNextStep() {
    if (validateStep(currentStep)) {
        if (currentStep === 3) {
            updateInstruments();
        }
        currentStep++;
        if (currentStep === 1) updateEmailDisplay();
        showStep(currentStep);
    }
}

function goToPreviousStep() {
    if (currentStep > 0) {
        currentStep--;
        showStep(currentStep);
    }
}

function validateStep(step: number): boolean {
    let isValid = true;
    if (step === 0) {
        const email = getInputValue('email');
        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            showError('emailError', 'Email inv√°lido.'); isValid = false;
        } else clearError('emailError');
    } else if (step === 1) {
        if (!getInputValue('fullName')) { showError('fullNameError', 'Nome obrigat√≥rio.'); isValid = false; } else clearError('fullNameError');
        const cpf = getInputValue('cpf');
        if (!cpf) { showError('cpfError', 'CPF obrigat√≥rio.'); isValid = false; }
        else if (!isValidCPF(cpf)) { showError('cpfError', 'CPF inv√°lido.'); isValid = false; } else clearError('cpfError');
        if (!getInputValue('address')) { showError('addressError', 'Endere√ßo obrigat√≥rio.'); isValid = false; } else clearError('addressError');
        const phone = getInputValue('phone');
        if (!phone || phone.replace(/\D/g, '').length < 10) { showError('phoneError', 'Celular inv√°lido.'); isValid = false; } else clearError('phoneError');
    } else if (step === 2) {
        if (!getInputValue('venueAddress')) { showError('venueAddressError', 'Endere√ßo do evento obrigat√≥rio.'); isValid = false; } else clearError('venueAddressError');
        if (!getInputValue('eventDate')) { showError('eventDateError', 'Data obrigat√≥ria.'); isValid = false; } else clearError('eventDateError');

        // Validar se h√° pre√ßos para o ano selecionado
        if (eventYear && pricingData.length === 0) {
            showError('eventDateError', 'N√£o h√° pre√ßos cadastrados para este ano. Entre em contato conosco.');
            isValid = false;
        }

        if (!getInputValue('guestCount')) { showError('guestCountError', 'N¬∫ de convidados obrigat√≥rio.'); isValid = false; } else clearError('guestCountError');
        const guestTime = getInputValue('guestArrivalTime');
        const ceremonyTime = getInputValue('ceremonyStartTime');
        if (!guestTime || !ceremonyTime) {
             if(!guestTime) showError('guestArrivalTimeError', 'Hor√°rio obrigat√≥rio.');
             if(!ceremonyTime) showError('ceremonyStartTimeError', 'Hor√°rio obrigat√≥rio.');
             isValid = false;
        } else {
            const [ah, am] = guestTime.split(':').map(Number);
            const [ch, cm] = ceremonyTime.split(':').map(Number);
            const totalA = ah * 60 + am;
            const totalC = ch * 60 + cm;
            const diff = totalC - totalA;
            if (diff < 0) { showError('ceremonyStartTimeError', 'Cerim√¥nia deve ser ap√≥s chegada.'); isValid = false; }
            else if (diff > 60) { showError('guestArrivalTimeError', 'Intervalo m√°x de 1h.'); isValid = false; }
            else { clearError('guestArrivalTimeError'); clearError('ceremonyStartTimeError'); }
        }
    } else if (step === 3) {
        if (!isInputChecked('formation')) { showError('formationError', 'Escolha uma forma√ß√£o.'); isValid = false; } else clearError('formationError');
    } else if (step === 4) {
        if (!isInputChecked('instruments')) { showError('instrumentsError', 'Escolha os instrumentos.'); isValid = false; } else clearError('instrumentsError');
    } else if (step === 5) {
        if (!isInputChecked('trumpet')) { showError('trumpetError', 'Escolha uma op√ß√£o.'); isValid = false; } else clearError('trumpetError');
    } else if (step === 6) {
        if (!isInputChecked('sound')) { showError('soundError', 'Escolha uma op√ß√£o.'); isValid = false; } else clearError('soundError');
    } else if (step === 7) {
        const terms = document.getElementById('acceptTerms') as HTMLInputElement | null;
        if (!terms || !terms.checked) { showError('termsError', 'Aceite os termos.'); isValid = false; } else clearError('termsError');
    } else if (step === 8) {
        if (!isInputChecked('payment')) { showError('paymentError', 'Escolha o pagamento.'); isValid = false; } else clearError('paymentError');
    }
    return isValid;
}

function showError(id: string, msg: string) {
    const el = document.getElementById(id);
    if (el) { el.textContent = msg; el.classList.add('active'); }
}
function clearError(id: string) {
    const el = document.getElementById(id);
    if (el) { el.textContent = ''; el.classList.remove('active'); }
}

function updateInstruments() {
    const formationCheckbox = document.querySelector('input[name="formation"]:checked') as HTMLInputElement | null;
    const selectedFormation = formationCheckbox ? formationCheckbox.value : null;
    const container = document.getElementById('instrumentsContainer');
    if (!container || !selectedFormation) return;
    const currentChecked = document.querySelector('input[name="instruments"]:checked') as HTMLInputElement | null;
    const currentVal = currentChecked ? currentChecked.value : null;
    container.innerHTML = '';
    const options = instrumentOptions[selectedFormation];
    if (options) {
        options.forEach(option => {
            const label = document.createElement('label');
            label.className = 'radio-option';
            const checkedAttr = (currentVal === option) ? 'checked' : '';
            label.innerHTML = `<input type="radio" name="instruments" value="${option}" required ${checkedAttr}><span class="radio-label">${option}</span>`;
            container.appendChild(label);
        });
    }
}

function updateSoundOptions() {
    const container = document.getElementById('soundOptionsContainer');
    if (!container) return;

    container.innerHTML = '';

    console.log('üîä Atualizando op√ß√µes de sonoriza√ß√£o...', pricingData);

    // Buscar op√ß√µes de sonoriza√ß√£o nos dados usando a mesma l√≥gica do getPriceByName
    const sound1 = pricingData.find(p => {
        const pacoteSample = p['Pacote Sample'];
        if (Array.isArray(pacoteSample)) {
            return pacoteSample.some(pkg => pkg.value?.toLowerCase().includes('sonoriza√ß√£o 1'));
        }
        if (typeof pacoteSample === 'string') {
            return pacoteSample.toLowerCase().includes('sonoriza√ß√£o 1');
        }
        return false;
    });

    const sound2 = pricingData.find(p => {
        const pacoteSample = p['Pacote Sample'];
        if (Array.isArray(pacoteSample)) {
            return pacoteSample.some(pkg => pkg.value?.toLowerCase().includes('sonoriza√ß√£o 2'));
        }
        if (typeof pacoteSample === 'string') {
            return pacoteSample.toLowerCase().includes('sonoriza√ß√£o 2');
        }
        return false;
    });

    console.log('üîä Sonoriza√ß√£o 1 encontrada:', sound1);
    console.log('üîä Sonoriza√ß√£o 2 encontrada:', sound2);

    // Op√ß√£o: Nenhuma sonoriza√ß√£o
    const noneOption = document.createElement('label');
    noneOption.className = 'radio-option';
    noneOption.innerHTML = `
        <input type="radio" name="sound" value="nenhum" required checked>
        <span class="radio-label">Sem Sonoriza√ß√£o (R$ 0,00)</span>
    `;
    container.appendChild(noneOption);

    // Op√ß√£o: Sonoriza√ß√£o 1
    if (sound1) {
        const precoPromo1 = sound1['Pre√ßo promocional'];
        const price1 = typeof precoPromo1 === 'string'
            ? parseFloat(precoPromo1)
            : (typeof precoPromo1 === 'number' ? precoPromo1 : 0);

        const option1 = document.createElement('label');
        option1.className = 'radio-option';
        option1.innerHTML = `
            <input type="radio" name="sound" value="sonorizacao_1" required>
            <span class="radio-label">Sonoriza√ß√£o 1 (R$ ${formatPrice(price1)})</span>
        `;
        container.appendChild(option1);
    }

    // Op√ß√£o: Sonoriza√ß√£o 2
    if (sound2) {
        const precoPromo2 = sound2['Pre√ßo promocional'];
        const price2 = typeof precoPromo2 === 'string'
            ? parseFloat(precoPromo2)
            : (typeof precoPromo2 === 'number' ? precoPromo2 : 0);

        const option2 = document.createElement('label');
        option2.className = 'radio-option';
        option2.innerHTML = `
            <input type="radio" name="sound" value="sonorizacao_2" required>
            <span class="radio-label">Sonoriza√ß√£o 2 (R$ ${formatPrice(price2)})</span>
        `;
        container.appendChild(option2);
    }
}

// Fun√ß√µes auxiliares para obter pre√ßos espec√≠ficos
function getPriceByFormation(formation: string): number {
    const map: { [key: string]: string } = {
        'dueto': 'Dueto Instrumental',
        'trio': 'Trio Instrumental',
        'quarteto': 'Quarteto Instrumental',
        'quinteto': 'Quinteto Instrumental'
    };
    return getPriceByName(map[formation] || '');
}

function getPriceByTrumpet(trumpet: string): number {
    return trumpet === 'um'
        ? getPriceByName('1 Trompete Triunfal')
        : getPriceByName('2 Trompetes Triunfais');
}

function getPriceBySound(sound: string): number {
    return sound === 'sonorizacao_1'
        ? getPriceByName('Sonoriza√ß√£o 1')
        : getPriceByName('Sonoriza√ß√£o 2');
}

// Fun√ß√µes auxiliares para labels
function getFormationLabel(formation: string): string {
    const labels: { [key: string]: string } = {
        'dueto': 'Dueto Instrumental',
        'trio': 'Trio Instrumental',
        'quarteto': 'Quarteto Instrumental',
        'quinteto': 'Quinteto Instrumental'
    };
    return labels[formation] || formation;
}

function getTrumpetLabel(trumpet: string): string {
    return trumpet === 'um' ? '1 Trompete Triunfal' : '2 Trompetes Triunfais';
}

function getSoundLabel(sound: string): string {
    return sound === 'sonorizacao_1' ? 'Sonoriza√ß√£o 1' : 'Sonoriza√ß√£o 2';
}

// Adicionar linha √† tabela de resumo
function addSummaryRow(tbody: HTMLElement, label: string, price: number) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td>${label}</td>
        <td style="text-align: right;">R$ ${formatPrice(price)}</td>
    `;
    tbody.appendChild(tr);
}

// Fun√ß√£o principal para calcular e exibir resumo
function calculateAndDisplaySummary() {
    const summaryBody = document.getElementById('pricingSummaryBody');
    const totalPriceEl = document.getElementById('totalPrice');
    const paymentSummaryEl = document.getElementById('paymentSummary');

    if (!summaryBody || !totalPriceEl || !paymentSummaryEl) return;

    summaryBody.innerHTML = '';
    let total = 0;

    // 1. Pacote de forma√ß√£o
    const formation = getCheckedValue('formation');
    const formationPrice = getPriceByFormation(formation);
    if (formationPrice > 0) {
        total += formationPrice;
        addSummaryRow(summaryBody, getFormationLabel(formation), formationPrice);
    }

    // 2. Trompete
    const trumpet = getCheckedValue('trumpet');
    if (trumpet !== 'nenhum') {
        const trumpetPrice = getPriceByTrumpet(trumpet);
        if (trumpetPrice > 0) {
            total += trumpetPrice;
            addSummaryRow(summaryBody, getTrumpetLabel(trumpet), trumpetPrice);
        }
    }

    // 3. Sonoriza√ß√£o
    const sound = getCheckedValue('sound');
    if (sound !== 'nenhum') {
        const soundPrice = getPriceBySound(sound);
        if (soundPrice > 0) {
            total += soundPrice;
            addSummaryRow(summaryBody, getSoundLabel(sound), soundPrice);
        }
    }

    // Exibir total
    totalPriceEl.textContent = `R$ ${formatPrice(total)}`;

    // Calcular e exibir parcelamento
    displayPaymentBreakdown(paymentSummaryEl, total);
}

// Exibir breakdown de pagamento
function displayPaymentBreakdown(container: HTMLElement, total: number) {
    const payment = getCheckedValue('payment');
    container.innerHTML = '';

    const h3 = document.createElement('h3');
    h3.textContent = 'Forma de Pagamento';
    container.appendChild(h3);

    if (payment === 'vista') {
        container.innerHTML += `
            <div class="installment">
                <span>√Ä Vista</span>
                <span><strong>R$ ${formatPrice(total)}</strong></span>
            </div>
        `;
    } else if (payment === '2x') {
        const first = total * 0.30; // 30% de sinal
        const second = total * 0.70; // 70% restante
        container.innerHTML += `
            <div class="installment">
                <span>1¬™ Parcela (30% - Sinal)</span>
                <span><strong>R$ ${formatPrice(first)}</strong></span>
            </div>
            <div class="installment">
                <span>2¬™ Parcela (70% - Restante na semana do evento)</span>
                <span><strong>R$ ${formatPrice(second)}</strong></span>
            </div>
        `;
    } else if (payment === '3x') {
        const installment = total / 3;
        container.innerHTML += `
            <div class="installment">
                <span>1¬™ Parcela (na assinatura)</span>
                <span><strong>R$ ${formatPrice(installment)}</strong></span>
            </div>
            <div class="installment">
                <span>2¬™ Parcela</span>
                <span><strong>R$ ${formatPrice(installment)}</strong></span>
            </div>
            <div class="installment">
                <span>3¬™ Parcela</span>
                <span><strong>R$ ${formatPrice(installment)}</strong></span>
            </div>
        `;
    }
}

function isValidCPF(cpf: string): boolean {
    cpf = cpf.replace(/\D/g, '');
    if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
    let sum = 0;
    for (let i = 0; i < 9; i++) sum += parseInt(cpf[i]) * (10 - i);
    let r = sum % 11;
    let d1 = r < 2 ? 0 : 11 - r;
    if (parseInt(cpf[9]) !== d1) return false;
    sum = 0;
    for (let i = 0; i < 10; i++) sum += parseInt(cpf[i]) * (11 - i);
    r = sum % 11;
    let d2 = r < 2 ? 0 : 11 - r;
    return parseInt(cpf[10]) === d2;
}

async function submitForm() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement | null;

    if (loadingOverlay) loadingOverlay.style.display = 'flex';
    if (submitBtn) submitBtn.disabled = true;

    try {
        // Verificar se o reCAPTCHA est√° carregado
        if (!(window as any).grecaptcha || !(window as any).grecaptcha.enterprise) {
            console.error('reCAPTCHA Enterprise n√£o est√° carregado');
            throw new Error('reCAPTCHA n√£o carregado');
        }

        // Obter token do reCAPTCHA Enterprise
        console.log('Obtendo token do reCAPTCHA...');
        const recaptchaToken = await (window as any).grecaptcha.enterprise.execute(
            '6LddECEsAAAAABtUQk25e_vpSNHPTCsQVeEDB96u',
            { action: 'submit_form' }
        );
        console.log('Token reCAPTCHA obtido:', recaptchaToken ? 'Sucesso' : 'Falhou');

        // Calcular valores para enviar
        const formation = getCheckedValue('formation');
        const trumpet = getCheckedValue('trumpet');
        const sound = getCheckedValue('sound');

        const preco_pacote = getPriceByFormation(formation);
        const preco_trompete = trumpet !== 'nenhum' ? getPriceByTrumpet(trumpet) : 0;
        const preco_sonorizacao = sound !== 'nenhum' ? getPriceBySound(sound) : 0;
        const valor_total = preco_pacote + preco_trompete + preco_sonorizacao;

        const formData = {
            nome_completo: getInputValue('fullName'),
            cpf: getInputValue('cpf'),
            rg: getInputValue('rg'),
            endereco_residencial: getInputValue('address'),
            celular: getInputValue('phone'),
            email: getInputValue('email'),
            nome_casa: getInputValue('venueName'),
            endereco_casa: getInputValue('venueAddress'),
            data_evento: getInputValue('eventDate'),
            horario_cerimonia: getInputValue('ceremonyStartTime'),
            horario_convidados: getInputValue('guestArrivalTime'),
            pacote: formation,
            trompete: trumpet,
            sonorizacao: sound,
            forma_pagamento: getCheckedValue('payment'),
            instrumentos_escolhidos: getCheckedValue('instruments'),

            // Novos campos de valores
            preco_pacote: preco_pacote,
            preco_trompete: preco_trompete,
            preco_sonorizacao: preco_sonorizacao,
            valor_total: valor_total,
            ano_evento: eventYear,
            observacoes: getInputValue('finalObservations'),

            recaptcha_token: recaptchaToken
        };

        console.log('Enviando dados para Google Apps Script...');
        console.log('URL:', googleScriptUrl);
        console.log('Dados:', formData);

        const response = await fetch(googleScriptUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        console.log('Resposta do servidor:', response);
        console.log('Status:', response.type);

        // Com no-cors, sempre consideramos sucesso se n√£o der erro
        console.log('Formul√°rio enviado com sucesso!');
        setTimeout(() => {
            if (loadingOverlay) loadingOverlay.style.display = 'none';
            showSuccessMessage();
        }, 1500);
    } catch (error) {
        console.error('ERRO ao enviar formul√°rio:', error);
        console.error('Detalhes do erro:', {
            message: (error as Error).message,
            stack: (error as Error).stack
        });

        // Mostrar erro ao usu√°rio
        setTimeout(() => {
            if (loadingOverlay) loadingOverlay.style.display = 'none';
            if (submitBtn) submitBtn.disabled = false;
            alert('Erro ao enviar o formul√°rio. Por favor, tente novamente ou entre em contato conosco.');
        }, 500);
    }
}

function showSuccessMessage() {
    const form = document.getElementById('contractForm');
    const successMsg = document.getElementById('successMessage');
    if (form) form.style.display = 'none';
    if (successMsg) {
        successMsg.style.display = 'block';
        successMsg.scrollIntoView({ behavior: 'smooth' });
    }
    const emailBar = document.getElementById('emailDisplayBar');
    if (emailBar) emailBar.style.display = 'none';
}

function setupEmailModal() {
    const modal = document.getElementById('emailModal');
    const editBtn = document.getElementById('editEmailBtn');
    const closeBtns = [document.getElementById('closeEmailModal'), document.getElementById('cancelEmailBtn')];
    const confirmBtn = document.getElementById('confirmEmailBtn');
    const emailInput = document.getElementById('email') as HTMLInputElement | null;
    const modalInput = document.getElementById('emailModalInput') as HTMLInputElement | null;
    const displayEmail = document.getElementById('displayedEmail');
    const errorMsg = document.getElementById('modalEmailError');

    if (editBtn) {
        editBtn.addEventListener('click', () => {
            if (modalInput) modalInput.value = emailInput ? emailInput.value : '';
            if (errorMsg) { errorMsg.textContent = ''; errorMsg.classList.remove('active'); }
            if (modal) modal.style.display = 'flex';
        });
    }
    closeBtns.forEach(btn => {
        if (btn) btn.addEventListener('click', () => { if (modal) modal.style.display = 'none'; });
    });
    if (confirmBtn) {
        confirmBtn.addEventListener('click', () => {
            const val = modalInput ? modalInput.value.trim() : '';
            if (!val || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val)) {
                if (errorMsg) { errorMsg.textContent = 'Email inv√°lido.'; errorMsg.classList.add('active'); }
                return;
            }
            if (emailInput) emailInput.value = val;
            if (displayEmail) displayEmail.textContent = val;
            if (modal) modal.style.display = 'none';
        });
    }
}

function updateEmailDisplay() {
    const emailInput = document.getElementById('email') as HTMLInputElement | null;
    const displayedEmail = document.getElementById('displayedEmail');
    if (displayedEmail && emailInput) displayedEmail.textContent = emailInput.value;
}

function setupInputMasks() {
    const cpfInput = document.getElementById('cpf') as HTMLInputElement | null;
    if (cpfInput) {
        cpfInput.addEventListener('input', (e) => {
            const target = e.target as HTMLInputElement;
            let v = target.value.replace(/\D/g, '');
            if (v.length > 11) v = v.substring(0, 11);
            if (v.length > 9) v = v.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
            else if (v.length > 6) v = v.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
            else if (v.length > 3) v = v.replace(/(\d{3})(\d{1,3})/, '$1.$2');
            target.value = v;
        });
    }
    const phoneInput = document.getElementById('phone') as HTMLInputElement | null;
    if (phoneInput) {
        phoneInput.addEventListener('input', (e) => {
            const target = e.target as HTMLInputElement;
            let v = target.value.replace(/\D/g, '');
            if (v.length > 11) v = v.substring(0, 11);
            if (v.length > 10) v = v.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            else if (v.length > 6) v = v.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
            else if (v.length > 2) v = v.replace(/(\d{2})(\d{0,5})/, '($1) $2');
            target.value = v;
        });
    }

    // Listener para data do evento - buscar pre√ßos do ano
    const eventDateInput = document.getElementById('eventDate') as HTMLInputElement | null;
    if (eventDateInput) {
        eventDateInput.addEventListener('change', async (e: Event) => {
            const target = e.target as HTMLInputElement;
            const date = new Date(target.value);
            eventYear = date.getFullYear();

            console.log('Ano do evento:', eventYear);

            // Buscar pre√ßos do ano
            await fetchPricingForYear(eventYear);

            // Atualizar op√ß√µes de sonoriza√ß√£o
            updateSoundOptions();
        });
    }
}
</script>

<!-- Google reCAPTCHA Enterprise Script -->
<script src={`https://www.google.com/recaptcha/enterprise.js?render=${recaptchaSiteKey}`} is:inline></script>
